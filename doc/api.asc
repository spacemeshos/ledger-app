Spacemesh application : Common Technical Specifications
=======================================================

## Features

  - Verify public address on the Ledger device
  - Display transaction information before allowing signature
  - Reject a transaction on the Ledger device
  - Sign a transaction on the Ledger device

The application interface can be accessed over HID or BLE

## General structure

The general structure of commands and responses is as follows:

#### Commands

| Field   | Type     | Content                | Note |
|:------- |:-------- |:---------------------- | ---- |
| CLA     | byte (1) | Application Identifier | 0x30 |
| INS     | byte (1) | Instruction ID         |      |
| P1      | byte (1) | Parameter 1            |      |
| P2      | byte (1) | Parameter 2            |      |
| L       | byte (1) | Bytes in payload       |      |
| PAYLOAD | byte (L) | Payload                |      |

#### Response

| Field   | Type     | Content     | Note                     |
| ------- | -------- | ----------- | ------------------------ |
| ANSWER  | byte (?) | Answer      | depends on the command   |
| SW1-SW2 | byte (2) | Return code | see list of return codes |

#### Return codes

[width="80%"]
| Return code | Description                                       |
| ----------- | ------------------------------------------------- |
| 0x6400      | Execution Error                                   |
| 0x6700      | Incorrect length                                  |
| 0x6982      | Security status not satisfied (Canceled by user)  |
| 0x6983      | Output buffer too small                           |
| 0x6986      | Command not allowed                               |
| 0x6A80      | Invalid data                                      |
| 0x6D00      | INS not supported                                 |
| 0x6E00      | CLA not supported                                 |
| 0x6B00      | Incorrect parameter P1 or P2                      |
| 0x6Fxx      | Technical problem (Internal error, please report) |
| 0x9000      | Normal ending of the command                      |

---------

## Command definition

### INS_VERSION

#### Command

| Field | Type     | Content                | Expected |
| ----- | -------- | ---------------------- | -------- |
| CLA   | byte (1) | Application Identifier | 0x30     |
| INS   | byte (1) | Instruction ID         | 0x00     |
| P1    | byte (1) | Parameter 1            | ignored  |
| P2    | byte (1) | Parameter 2            | ignored  |
| L     | byte (1) | Bytes in payload       | 0        |

#### Response

| Field   | Type     | Content       | Note                            |
| ------- | -------- | ------------- | ------------------------------- |
| MAJOR   | byte (1) | Version Major |                                 |
| MINOR   | byte (1) | Version Minor |                                 |
| PATCH   | byte (1) | Version Patch |                                 |
| FLAGS   | byte (1) | Version Flags |                                 |
| SW1-SW2 | byte (2) | Return code   | see list of return codes        |

### INS_PUBLIC_KEY

#### Command

| Field | Type     | Content                           | Expected |
| ----- | -------- | --------------------------------- | -------- |
| CLA   | byte (1) | Application Identifier            | 0x30     |
| INS   | byte (1) | Instruction ID                    | 0x10     |
| P1    | byte (1) | Request type:                     |          |
|       |          |  returning address to host        | 0x01     |
|       |          |  displaying address on the screen | 0x02     |
| P2    | byte (1) | Parameter 2                       | ignored  |
| L     | byte (1) | Bytes in payload                  | vary     |

##### Payload

| BIP32 path len                    | 1      | min 2, max 10             |
| First derivation index            | 4      | Big endian. Must be 44'   |
| Second derivation index           | 4      | Big endian. Must be 540'  |
| (optional) Third derivation index | 4      | Big endian                |
| ...                               | ...    | ...                       |
| (optional) Last derivation index  | 4      | Big endian                |

#### Response

| Field   | Type     | Content       | Note                            |
| ------- | -------- | ------------- | ------------------------------- |
| PUBKEY  | byte (20)| Public Key    |                                 |
| SW1-SW2 | byte (2) | Return code   | see list of return codes        |

### INS_SIGN

#### Command

| Field | Type     | Content                | Expected |
| ----- | -------- | ---------------------- | -------- |
| CLA   | byte (1) | Application Identifier | 0x30     |
| INS   | byte (1) | Instruction ID         | 0x20     |
| P1    | byte (1) | Parameter 1            | ignored  |
| P2    | byte (1) | Parameter 2            | ignored  |
| L     | byte (1) | Bytes in payload       | 52       |

##### Payload

| Account Nonce   | 8  | Big endian  |
| Recipient       | 20 |             |
| Gas Limit       | 8  | Big endian  |
| Price           | 8  | Big endian  |
| Amount          | 8  | Big endian  |

#### Response

| Field   | Type      | Content       | Note                     |
| ------- | --------- | ------------- | -------------------------|
| SIGN    | byte (64) | Signature     |                          |
| SW1-SW2 | byte (2)  | Return code   | see list of return codes |

